<?php defined('SYSPATH') or die('No direct script access.');class Controller_Frontend_Ajax_Film extends Controller_Frontend_Ajax{    public function action_index()    {        parent::before();        //$this->_assert_ajax_only();    }    public function action_notifications()    {        $film_id = $this->_input->filter_single('film_id', Light_Input::UINT);        $status = $this->_input->filter_single('spin', Light_Input::STRING);        $film_model = $this->_get_film_model();        $fetch_options = array('select_fields' => array('film.film_id', 'film.status', 'film.title', 'film.title_o'));        if (empty($film_id) OR !$film = $film_model->get_film_by_id($film_id, $fetch_options)) {            return $this->response_json(array(                'error' => TRUE,                'message' => __('Film is invalid.'),                'alert' => TRUE,            ));        }        if (!$_COOKIE['notify'][$film_id]) {            $arr = array('status' => $status);            $json = json_encode($arr, true);            Cookie::set("notify[$film_id]", $json);        } else {            return $this->response_json(array(                'error' => TRUE,                'message' => __('Phim này bạn đã đăng ký rồi!'),            ));        }        return $this->response_json(array(            'message' => __('Liked success.'),            'film' => $film,        ));    }    public function action_rate()    {        $film_id = $this->_input->filter_single('film_id', Light_Input::UINT);        $score = $this->_input->filter_single('pin', Light_Input::STRING);        $film_model = $this->_get_film_model();        $fetch_options = array(            'select_fields' => array('film.film_id', 'film.liked_times', 'film.liked_vote'),        );        if (empty($film_id) OR !$film = $film_model->get_film_by_id($film_id, $fetch_options)) {            return $this->response_json(array(                'error' => TRUE,                'message' => __('Film is invalid.'),                'alert' => TRUE,            ));        }        if ($film['liked_times_float'] == 0) {            $film['liked_times_float'] = '0.1';        }        $floatnum = $film['liked_vote'] * $film['liked_times'] / Light_Config::get('config.censor.ratestar');        if (!Cookie::get('rate-' . $film_id)) {            $rate = round(base64_decode($score)) + $film['liked_vote'];            $film_model->update($film_id, 'liked_times', 'liked_times + 1', TRUE);            $film_model->update($film_id, 'liked_vote', $rate, TRUE);            $film_model->update($film_id, 'liked_times_float', $film['liked_times_float'] + number_format($floatnum, 1, '.', ''), TRUE);            Cookie::set('rate-' . $film_id, 1);            $film['liked_times'] += 1;        }        $film['liked_vote'] = $rate;        $film['frate_format'] = $film['liked_times_float'] + number_format($floatnum, 1, '.', '');        return $this->response_json(array(            'message' => __('Liked success.'),            'film' => $film,        ));    }    public function action_search()    {        $keyword = $this->_input->filter_single('keyword', Light_Input::STRING);        $films = array();        if ($keyword) {            $film_model = $this->_get_film_model();            //$criteria = array('keyword' => $keyword);            $criteria = array('keyword' => $keyword);            $count_films = $film_model->get_count_films($criteria);            if ($count_films) {                $films = $film_model->get_films($criteria, array(                    'order' => array(                        'film.year' => 'DESC',                        'film.last_update' => 'DESC',                    ),                    'limit' => 10,                    'some_fields' => TRUE,                ));                $films = array_map('Light_Helper_Film::parse', $films);            }        }        return $this->response_json(array(            'json' => $films,        ));    }} 