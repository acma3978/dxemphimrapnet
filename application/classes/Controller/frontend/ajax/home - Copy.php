<?phpdefined('SYSPATH') or die('No direct script access.');class Controller_Frontend_Ajax_Home extends Controller_Frontend_Ajax{    public function before()        {        parent::before();        //$this->_assert_ajax_only();        }    protected function _cron_build_sitemap()        {        $registry_model = $this->_get_registry_model();        $old_date = 0;        try            {            $old_date = $registry_model->get('sitemap_builded_time');            }        catch(Exception $e)            {            $old_date = 0;            }        if ($old_date < strtotime('today') OR !file_exists(DOCROOT . 'sitemap.xml'))            {            $build = Light_Helper_Base::build_sitemap();            if (!$build)                {                throw new Light_Exception(__METHOD__ . ': Cron build sitemap failed.');                }            $registry_model->set('sitemap_builded_time', Light_Application::$time);            }        }    public function action_tab()        {        $type = $this->_input->filter_single('type', Light_Input::STRING);        switch($type){        case 'ajax-phim-danh-gia':            echo '<pre>';            print_r(222);            echo '</pre>';            if (!$this->_caching OR !$phim_danh_gia = $this->_cache->get('phim_danh_gia'))                {                $i = 1;                $count_phim_danh_gia = $this->_get_film(NULL, NULL, 12, FALSE, $this->_objectSel["option"] = array(                    'order' => array(                        'film.liked_vote' => 'DESC',                        'film.year' => 'DESC'                    )                ));                foreach($count_phim_danh_gia as $k => $item)                    {                    if ($i == 1)                        {                        $phim_danh_gia[top][$i] = $item;                        }                    elseif ($i == 2)                        {                        $phim_danh_gia[middle][$i] = $item;                        }                    elseif ($i > 2)                        {                        $phim_danh_gia[last][$i] = $item;                        }                    $i++;                    }                !$this->_caching OR $this->_cache->set('phim_danh_gia', $phim_danh_gia);                }            $html = $this->view('home/tab_home')->set('phim_danh_gia', $phim_danh_gia)->render();            break;        case 'phim-hai-huoc':            if (!$this->_caching OR !$phim_hai_huoc = $this->_cache->get('phim_hai_huoc'))                {                $phim_hai_huoc = $this->_get_film(NULL, 4, 12, FALSE, $this->_objectSel["option"] = array(                    'order' => array(                        'film.last_update_episode' => 'DESC'                    )                ));                !$this->_caching OR $this->_cache->set('phim_hai_huoc', $phim_hai_huoc);                }            $html = $this->view('home/tab_home')->set('phim_hai_huoc', $phim_hai_huoc)->render();            break;        case 'phim-kinh-di':            if (!$this->_caching OR !$phim_kinh_di = $this->_cache->get('phim_kinh_di'))                {                $phim_kinh_di = $this->_get_film(NULL, 8, 8, FALSE, $this->_objectSel["option"] = array(                    'order' => array(                        'film.last_update_episode' => 'DESC'                    )                ));                !$this->_caching OR $this->_cache->set('phim_kinh_di', $phim_kinh_di);                }            $html = $this->view('home/tab_home')->set('phim_kinh_di', $phim_kinh_di)->render();            break;        case 'phim-tam-ly':            if (!$this->_caching OR !$phim_tam_ly = $this->_cache->get('phim_tam_ly'))                {                $phim_tam_ly = $this->_get_film(NULL, 13, 12, FALSE, $this->_objectSel["option"] = array(                    'order' => array(                        'film.last_update_episode' => 'DESC'                    )                ));                !$this->_caching OR $this->_cache->set('phim_tam_ly', $phim_tam_ly);                }            $html = $this->view('home/tab_home')->set('phim_tam_ly', $phim_tam_ly)->render();            break;        case 'phim-tinh-cam':            if (!$this->_caching OR !$phim_tinh_cam = $this->_cache->get('phim_tinh_cam'))                {                $phim_tinh_cam = $this->_get_film(NULL, 13, 12, FALSE, $this->_objectSel["option"] = array(                    'order' => array(                        'film.last_update_episode' => 'DESC'                    )                ));                !$this->_caching OR $this->_cache->set('phim_tinh_cam', $phim_tinh_cam);                }            $html = $this->view('home/tab_home')->set('phim_tinh_cam', $phim_tinh_cam)->render();            break;        case 'phim-vo-thuat':            if (!$this->_caching OR !$phim_vo_thuat = $this->_cache->get('phim_vo_thuat'))                {                $phim_vo_thuat = $this->_get_film(NULL, 17, 12, FALSE, $this->_objectSel["option"] = array(                    'order' => array(                        'film.last_update_episode' => 'DESC'                    )                ));                !$this->_caching OR $this->_cache->set('phim_vo_thuat', $phim_vo_thuat);                }            $html = $this->view('home/tab_home')->set('phim_vo_thuat', $phim_vo_thuat)->render();            break;        case 'phim-hanh-dong':            if (!$this->_caching OR !$phim_hanh_dong = $this->_cache->get('phim_hanh_dong'))                {                $phim_hanh_dong = $this->_get_film(NULL, 1, 12, FALSE, $this->_objectSel["option"] = array(                    'order' => array(                        'film.last_update_episode' => 'DESC'                    )                ));                !$this->_caching OR $this->_cache->set('phim_hanh_dong', $phim_hanh_dong);                }            $html = $this->view('home/tab_home')->set('phim_hanh_dong', $phim_hanh_dong)->render();            break;        case 'phim-hong-kong':            if (!$this->_caching OR !$phim_hong_kong = $this->_cache->get('phim_hong_kong'))                {                $phim_hong_kong = $this->_get_film(0, NULL, 12, FALSE, $this->_objectSel["option"] = array(                    'order' => array(                        'film.last_update' => 'DESC',                        'film.year' => 'DESC',                        'film.views_day' => 'DESC'                    ) ,                    'conditions' => array(                        'country_id' => 8                    )                ));                !$this->_caching OR $this->_cache->set('phim_hong_kong', $phim_hong_kong);                }            $html = $this->view('home/tab_home')->set('phim_hong_kong', $phim_hong_kong)->render();            break;        case 'phim-thai-lan':            if (!$this->_caching OR !$phim_thai_lan = $this->_cache->get('phim_thai_lan'))                {                $phim_thai_lan = $this->_get_film(0, NULL, 12, FALSE, $this->_objectSel["option"] = array(                    'order' => array(                        'film.last_update' => 'DESC',                        'film.year' => 'DESC',                        'film.views_day' => 'DESC'                    ) ,                    'conditions' => array(                        'country_id' => 9                    )                ));                !$this->_caching OR $this->_cache->set('phim_thai_lan', $phim_thai_lan);                }            $html = $this->view('home/tab_home')->set('phim_thai_lan', $phim_thai_lan)->render();            break;        case 'phim-dai-loan':            if (!$this->_caching OR !$phim_dai_loan = $this->_cache->get('phim_dai_loan'))                {                $phim_dai_loan = $this->_get_film(0, NULL, 12, FALSE, $this->_objectSel["option"] = array(                    'order' => array(                        'film.last_update' => 'DESC',                        'film.year' => 'DESC',                        'film.views_day' => 'DESC'                    ) ,                    'conditions' => array(                        'country_id' => 17                    )                ));                !$this->_caching OR $this->_cache->set('phim_dai_loan', $phim_dai_loan);                }            $html = $this->view('home/tab_home')->set('phim_dai_loan', $phim_dai_loan)->render();            break;        case 'ajax-category':            if (!$phim_category = $this->_cache->get('phim_category')){                $phim_category = $this->_get_phim_category(5);                //!$this->_caching OR $this->_cache->set('phim_category', $phim_category);                }            $html = $this->view('home/tab_home')->set('phim_category', $phim_category)->render();            break;        case 'ajax-category-title':            $title_ascii = $this->_input->filter_single('title_ascii', Light_Input::STRING);            $title_o_ascii = $this->_input->filter_single('title_o_ascii', Light_Input::STRING);            if (!$phim_related_title = $this->_cache->get('phim_related_title'))                {                $phim_related_title = $this->_get_film(0, NULL, '8', NULL, $this->_objectSel["option"] = array(                    'order' => array(                        'film.year' => 'DESC',                        'film.last_update_episode' => 'DESC'                    ) ,                    'conditions' => array(                            //'title' => 'dsadsadsa',                            'title_idx' => '111'                    )                ));                !$this->_caching OR $this->_cache->set('phim_related_title', $phim_related_title);                }            $html = $this->view('home/tab_home')->set('phim_related_title', $phim_related_title)->render();            break;        case 'ajax-phim-bo-moi-year':            if (!$this->_caching OR !$bo_moi_theo_nam = $this->_cache->get('bo_moi_theo_nam'))                {                $bo_moi_theo_nam = $this->_get_film(2, NULL, 12, FALSE, $this->_objectSel["option"] = array(                    'order' => array(                        'film.post_date' => 'DESC',                        'film.views' => 'DESC',                        'film.year' => 'DESC'                    )                ));                !$this->_caching OR $this->_cache->set('bo_moi_theo_nam', $bo_moi_theo_nam);                }            $html = $this->view('home/tab_home')->set('bo_moi_theo_nam', $bo_moi_theo_nam)->render();            break;        case 'ajax-phim-le-moi':            if (!$this->_caching OR !$le_moi_theo_nam = $this->_cache->get('le_moi_theo_nam'))                {                $le_moi_theo_nam = $this->_get_film(1, NULL, 12, FALSE, $this->_objectSel["option"] = array(                    'order' => array(                        'film.post_date' => 'DESC',                        'film.views' => 'DESC',                        'film.year' => 'DESC'                    )                ));                !$this->_caching OR $this->_cache->set('le_moi_theo_nam', $le_moi_theo_nam);                }            $html = $this->view('home/tab_home')->set('le_moi_theo_nam', $le_moi_theo_nam)->render();            break;                        case 'ajax-phim-hoat-hinh':                if (!$this->_caching OR !$phim_hoat_hinh = $this->_cache->get('phim_hoat_hinh')){                    $phim_hoat_hinh = $this->_get_film(NULL, 6, 8, FALSE, $this->_objectSel["option"] = array('order' => array('film.last_update_episode' => 'DESC')));!$this->_caching OR $this->_cache->set('phim_hoat_hinh', $phim_hoat_hinh);                }                    $html = $this->view('home/tab_home')->set('phim_hoat_hinh', $phim_hoat_hinh)->render();            break;        case 'ajax-film-stick':            if (!$this->_caching OR !$phim_moi_sticker = $this->_cache->get('phim_moi_sticker'))                {                $phim_moi_sticker = $this->_get_film(0, NULL, 4, FALSE, $this->_objectSel["option"] = array(                    'order' => array(                        'film.views_day' => 'DESC',                        'film.year' => 'DESC'                    ) ,                    'conditions' => array(                        'options' => 'phim_moi_sticker'                    )                ));                !$this->_caching OR $this->_cache->set('phim_moi_sticker', $phim_moi_sticker);                }            $html = $this->view('home/tab_home')->set('phim_moi_sticker', $phim_moi_sticker)->render();            break;        case 'ajax-phim-moi-nhat-xem-nhieu':            if (!$this->_caching OR !$phim_moi_nhat_xem_nhieu = $this->_cache->get('phim_moi_nhat_xem_nhieu'))                {                $i = 1;                $count_phim_moi_nhat_xem_nhieu = $this->_get_film(NULL, NULL, 12, FALSE, $this->_objectSel["option"] = array(                    'order' => array(                        'film.views_day' => 'DESC',                        'film.last_update_episode' => 'DESC',                        'film.year' => 'DESC'                    )                ));                foreach($count_phim_moi_nhat_xem_nhieu as $k => $item)                    {                    if ($i == 1)                        {                        $phim_moi_nhat_xem_nhieu[top][$i] = $item;                        }                    elseif ($i == 2)                        {                        $phim_moi_nhat_xem_nhieu[middle][$i] = $item;                        }                    elseif ($i > 2)                        {                        $phim_moi_nhat_xem_nhieu[last][$i] = $item;                        }                    $i++;                    }                !$this->_caching OR $this->_cache->set('phim_moi_nhat_xem_nhieu', $phim_moi_nhat_xem_nhieu);                }            $html = $this->view('home/tab_home')->set('phim_moi_nhat_xem_nhieu', $phim_moi_nhat_xem_nhieu)->render();            break;            }        echo $html;        }    protected function _get_episode_model()        {        return $this->get_model('Light_Model_Episode');        }    protected function _get_film_model()        {        return $this->get_model('Light_Model_Film');        }    public function after()        {        $this->_cron_build_sitemap();        parent::after();        }    }