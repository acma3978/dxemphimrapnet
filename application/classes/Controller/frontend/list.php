<?php defined('SYSPATH') or die('No direct script access.');class Controller_Frontend_List extends Controller_Frontend {	protected function _perpare_criteria_for_search(array $filters)	{		$criteria = array();		foreach(array('country_id', 'category_id', 'year', 'post_user_id') as $field)		{			if( ! empty($filters[$field]))			{				$criteria[$field] = $filters[$field];			}		}	//	$criteria['order'] = array('film.last_update' => 'DESC');		$criteria['order'] = array('film.post_date' => 'DESC');		if( in_array($filters['order_by'], array('views', 'title', 'last_update', 'year', 'liked_times')))		{			$criteria['order'] = array('film.' . $filters['order_by'] => 'DESC');		}		$criteria['active'] = 1;		return $criteria;	}		public function action_index()	{		$list_info = array('name' => $this->request->param('name'));				$film_model = $this->_get_film_model();		$page = $this->_input->filter_single('page', Light_Input::UINT);		$page = max($page, 1);		$perpage = Light_Application::get('options')->films_per_page;				$filters = $this->_input->filter(array(			'order_by'		=> Light_Input::STRING,			'year' 			=> Light_Input::UINT,			'country_id'	=> Light_Input::UINT,			'category_id'	=> Light_Input::UINT,		));		// to SEO		$year = date('Y');				$criteria = $this->_perpare_criteria_for_search($filters);				$view_params = array(			'show'	=> array(				'country_filter' 	=> 1,				'category_filter' 	=> 1,				'year_filter' 		=> 1,				'order_filter' 		=> 1,			),		);				switch($list_info['name'])		{			// old url			case 'phim-moi-cap-nhat':				$list_info['name'] 		= 'phim-moi';								$this->redirect(					Light_Link::build('list', $list_info, NULL, TRUE, TRUE)				, 301);				break;							case 'phim-moi':				$block['title'] 		= 'Phim mới';					$criteria['order']		= array('film.post_date' => 'DESC'); // override								$view_params['show']['order_filter'] = 0;								$view_params += array(                    'page_title'		=> "Danh sách phim mới nhất $year, phim hot $year",                    'page_keywords'		=> "phim mới cập nhật, phim $year, phim hay chọn lọc, phim hot $year, phim $year mới nhất",                    'page_description'	=> "Phim mới, Phim mới $year, Danh sách phim mới cập nhật, trang tổng hợp các phim mới nhất, hay nhất $year.."				);					break;							case 'phim-chieu-rap':				$criteria['options'] = 'phim_chieu_rap_hot'; // phim chiếu rạp								if(empty($filters['order_by']))				{					$criteria['order']		= array('film.post_date' => 'DESC'); // override				}				if($filters['year'])				{					$year = $filters['year'];										$block['title'] 		= 'Danh sách phim chiếu rạp ' . $year;					$view_params += array(                        'page_title'		=> "Danh sách phim chiếu rạp $year hay nhất, phim chiếu rạp mới nhất $year",                        'page_keywords'		=> "phim chiếu rạp $year, phim $year chiếu rạp, xem phim chiếu rạp $year, phim chiếu rạp, phim chiếu rạp hay, phim chiếu rạp mới",                        'page_description'	=> "Phim chiếu rạp $year, danh sách phim chiếu rạp hot $year",					);					}				else				{					$block['title'] 		= 'Danh sách phim chiếu rạp';					$view_params += array(                        'page_title'		=> "Xem Phim Chiếu Rạp hay, mới nhất $year, Tong hop phim chieu rap moi $year",                        'page_keywords'		=> "phim chiếu rạp, phim $year chiếu rạp, xem phim chiếu rạp $year, phim chiếu rạp, phim chiếu rạp hay, phim chiếu rạp mới",                        'page_description'	=> "Tổng hợp tất cả những bộ Phim Chiếu Rạp hay nhất và mới nhất $year, phim chieu rap hot $year, những bộ phim chieu rap của Việt Nam và điện ảnh thế giới..."					);				}				break;							case 'phim-le':				$criteria['type'] = 1; // phim lẻ								if($filters['year'])				{					$year = $filters['year'];										$block['title'] 		= 'Phim lẻ ' . $year;					$view_params += array(                        'page_title'		=> "Phim lẻ $year, Danh sách phim lẻ $year chọn lọc",                        'page_keywords'		=> "phim lẻ, xem phim $year, phim hot $year, phim lẻ $year, download phim $year",                        'page_description'	=> "Phim lẻ $year mới nhất, danh sách phim lẻ $year. Tổng hợp những phim lẻ hay nhất, hấp dẫn nhất $year..."					);				}				else				{					$block['title'] 		= 'Phim lẻ';					$view_params += array(                        'page_title'		=> "Phim lẻ mới nhất, Phim lẻ hay, Phim lẻ hot $year",                        'page_keywords'		=> "phim lẻ, xem phim $year, phim hot $year, phim lẻ $year, download phim $year",                        'page_description'	=> "Danh sách phim lẻ mới nhất $year, phim lẻ $year hay chọn lọc, phim lẻ $year"					);				}				break;			case 'phim-bo':								$criteria['type'] = 2; // phim bộ				if($filters['year'])				{					$year = $filters['year'];										$block['title'] 		= 'Phim bộ ' . $year;					$view_params += array(                        'page_title'		=> "Phim bộ $year, Danh sách phim bộ $year mới nhất",                        'page_keywords'		=> "phim bộ, xem phim $year, phim hot $year, phim bộ $year, download phim $year",                        'page_description'	=> "Phim bộ $year, danh sách phim bộ $year hay và hot nhất. Tổng hợp phim bộ $year..."					);				}				else				{					$block['title'] 		= 'Phim bộ';						$view_params += array(                        'page_title'		=> "Phim bộ mới nhất, phim bộ hay, phim bộ hot $year",                        'page_keywords'		=> "phim bộ, phim bộ hay, phim bộ hot, phim bộ mới, xem phim bộ, tải phim bộ dài tập, phim dai tap",                        'page_description'	=> "Danh sách phim mới nhất, phim bộ hay, phim bộ $year. Tổng hợp phim bộ hay và hấp dẫn nhất ..."					);					}			break;                case 'dien-vien':                    $block['title'] 		= 'Danh sách Diễn Viên';                    $view_params += array(                        'page_title'		=> "Danh sách Diễn viên",                        'page_keywords'		=> "Danh sách Diễn viên",                        'page_description'	=> "Danh sách Diễn viên nổi tiếng hàng đầu thế giới đến từ nhiều quốc gia như mỹ, hàn quốc, hong kong , đài loan, trung quốc, việt nam , thái lan và một số quốc gia khác"                    );                    break;			default:				if(preg_match('#phim-(?P<year>[\d]{4})#', $list_info['name'], $match))				{					$_year = Light_Input::raw_filter($match['year'], Light_Input::UINT);					$criteria['year'] = $_year;										$block['title'] 	= "Phim $_year, Phim mới nhất $_year";					$view_params += array(                        'page_title'		=> "Phim $_year, Xem phim hot $_year, phim mới nhất $_year",                        'page_keywords'		=> "Phim $_year, xem phim $_year, phim chiếu rạp $_year, phim hot $_year",                        'page_description'	=> "Phim mới $_year, phim hot $_year, tổng hợp phim $_year "					);											$view_params['show']['year_filter'] = FALSE;				}					break;			}				$count_films = $film_model->get_count_films($criteria);		$total_pages = ceil($count_films/$perpage);		$page = min($page, $total_pages);		$films = array();		if($count_films)		{			$films = $film_model->get_films($criteria, array(				'page' => $page,				'perpage' => $perpage,				'order' => $criteria['order'],			));			$films = array_map('Light_Helper_Film::parse', $films);		}				list($left, $right) = explode('__page', 			Light_Link::build('list', $list_info + array('page' => '__page'), $this->request->query())		);		$page_nav = Light_Helper_Base::page_navigation($page, $total_pages, $left, $right);				if($page > 1)		{			$list_info += array('page' => $page);		}		$view_params += array(			'filters' => $filters,			'films' => $films,			'block' => $block,			'page_nav' => $page_nav,		);				return $this->response_view('list', $view_params);	}		protected function _get_film_model()	{		return $this->get_model('Light_Model_Film');	}	} 