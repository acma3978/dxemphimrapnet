<?php defined('SYSPATH') or die('No direct script access.');class Controller_Frontend_Search extends Controller_Frontend {	protected function _perpare_criteria_for_search(array $filters)	{		$criteria = array();		foreach(array('country_id', 'category_id', 'year', 'post_user_id') as $field)		{			if( ! empty($filters[$field]))			{				$criteria[$field] = $filters[$field];			}		}		//$criteria['order'] = array('film.last_update' => 'DESC');		$criteria['order'] = array('film.post_date' => 'DESC');		if( in_array($filters['order_by'], array('views', 'title', 'last_update', 'year', 'liked_times')))		{			$criteria['order'] = array('film.' . $filters['order_by'] => 'DESC');		}		$criteria['active'] = 1;		return $criteria;	}		public function action_index()	{		$keyword = strtr($this->_input->filter_single('keyword', Light_Input::STRING), '-', ' ');		$keyword = preg_replace('#phim|xem\s*phim#u', '', $keyword);		$keyword = strip_tags($keyword);		$keyword = trim($keyword);				if($keyword == 'han quoc tiem rau my nam')		{			$this->redirect('http://phim3s.net/phim/tiem-my-my-nam_flower-boy-ramyun-shop.1473/');		}				if($keyword == 'sex' OR $keyword == 'cap 3')		{			$this->redirect('http://bitphim.net/tag/phim-' . $keyword);		}						$search_info = array('keyword' => $keyword);				// fix search		if( ! strcasecmp($keyword, 'bo hay'))		{			$this->redirect(Light_Link::build('list', 'name=phim-bo', NULL, TRUE, TRUE), 301);		}		if( ! strcasecmp($keyword, 'HOAT HINH POKEMON TRUYEN THUYET'))		{			$this->redirect(Light_Link::build('search', 'keyword=pokemon', 's=' . $keyword, TRUE, TRUE), 301);		}		if( ! strcasecmp($keyword, 'Hoat Hinh Pokemon Tap 753'))		{			$this->redirect(Light_Link::build('search', 'keyword=pokemon', 's=' . $keyword, TRUE, TRUE), 301);		}		if( ! strcasecmp($keyword, 'he lo thong tin ve sat thu nikita phan 3'))		{			$this->redirect(Light_Link::build('search', 'keyword=sat-thu-nikita-3', 's=' . $keyword, TRUE, TRUE), 301);		}		$film_model = $this->_get_film_model();				$page = $this->_input->filter_single('page', Light_Input::UINT);		$page = max($page, 1);		$perpage = Light_Application::get('options')->films_per_page;				$filters = $this->_input->filter(array(			'order_by'		=> Light_Input::STRING,			'year' 			=> Light_Input::UINT,			'country_id'	=> Light_Input::UINT,			'country_id'	=> Light_Input::UINT,		));		// to SEO		$year = date('Y');				$block['title'] 		= "Phim $keyword";				$view_params = array(			'show'	=> array(				'country_filter' 	=> 1,				'category_filter' 	=> 1,				'year_filter' 		=> 1,				'order_filter' 		=> 1,			),		);				$count_films = 0;		$total_pages = 0;		$films = array();				if($keyword)		{			// prepare criteria			$criteria = $this->_perpare_criteria_for_search($filters);			$criteria += array(				'keyword' => $keyword,			);						$count_films = $film_model->get_count_films($criteria);			$total_pages = ceil($count_films/$perpage);			$page = min($page, $total_pages);			if($count_films)			{				$films = $film_model->get_films($criteria, array(					'page' => $page,					'perpage' => $perpage,					'order' => $criteria['order'],				));				$films = array_map('Light_Helper_Film::parse', $films);			}		}				$title = Light_Helper_Unicode::ucwords($keyword);		$view_params += array(			'page_title'		=> "Phim $title - Xem phim $title",			'page_keywords'		=> "$title, Phim $title, Xem phim $title, download $title, tải phim $title",			'page_description'	=> "Xem phim $title, Tổng hợp các bộ phim về $title, $title. Các kết quả cho phim $title...",		);							list($left, $right) = explode('__page', 			Light_Link::build('search', $search_info + array('page' => '__page'), $this->request->query())		);		$page_nav = Light_Helper_Base::page_navigation($page, $total_pages, $left, $right);				if($page > 1)		{			$search_info += array('page' => $page);		}		$view_params += array(			'search_info' => $search_info,			'filters' => $filters,			'films' => $films,			'block' => $block,			'page_nav' => $page_nav,		);				return $this->response_view('list', $view_params);	}} 