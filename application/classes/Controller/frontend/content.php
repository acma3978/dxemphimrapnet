<?php defined('SYSPATH') or die('No direct script access.');class Controller_Frontend_Content extends Controller_Frontend {    public function action_index()    {        $film_id = $this->_input->filter_single('film_id', Light_Input::UINT);        if($film_id == 429)        {            $this->redirect('http://bitphim.net/phim-le/nhuc-bo-doan-2_367/', 301);        }        $fetch_otions = array(            'active_only' => TRUE,            'join'	=> Light_Model_Film::FETCH_COUNTRYINFO | Light_Model_Film::FETCH_USERINFO,        );        if(empty($film_id) OR !$filminfo = $this->_get_film_model()->get_film_by_id($film_id, $fetch_otions))        {            $this->redirect(                Light_Link::build('error', 'action=404', 'path=' . $this->request->uri())            );        }        $filminfo = Light_Helper_Content::parse($filminfo, array('tags' => TRUE));        // check correct url        $url_canonical = Light_Link::film('content', $filminfo, NULL, TRUE, TRUE);       /* if(Light_Link::film('film', $this->request->param(), NULL, TRUE, TRUE) != $url_canonical)        {            $this->redirect($url_canonical, 301);        }*/        // embed        #$filminfo['trailer_embed'] = Player::render($filminfo['trailer_url']);        // to beautiful        $filminfo['actor'] = str_replace(',', ', ', $filminfo['actor']);        $filminfo['has_episode'] = $filminfo['episode_latest'] > -1;        // xóa attributes của img        $count = preg_match_all('#<img.+?src=[\'|"](?P<src>https?://[^"\']+)[\'|"].*?/?>#is', $filminfo['pagetext'], $matches);        for($i = 0; $i < $count; $i ++)        {            $filminfo['pagetext'] = str_replace(                $matches[0][$i],                '<img title="'.$filminfo['title'].' - Image '.($i+1).'" alt="'.$filminfo['title'].' - Image '.($i+1).'" src="'.$matches['src'][$i].'" />',                $filminfo['pagetext']            );        }        //$filminfo['pagetext'] = preg_replace('#//img[\d]+\.#', '//a.', $filminfo['pagetext']);        // backup a, img        $count = preg_match_all('#<a[^>]+>.*?</a>|<img[^>]+>#is', $filminfo['pagetext'], $matches);        $replaces = array();        foreach($matches[0] as $a)        {            $replaces[md5($a)] = $a;        }        $filminfo['pagetext'] = str_ireplace(array_values($replaces), array_keys($replaces), $filminfo['pagetext']);        $filminfo['pagetext'] = preg_replace('#(phim)\s+#iu',            '<a href="/" title="$1"><strong>$1</strong></a> ',            $filminfo['pagetext'], 1        );        $filminfo['pagetext'] = preg_replace('#(xem phim)\s+#iu',            '<a href="/" title="$1"><strong>$1</strong></a> ',            $filminfo['pagetext'], 1        );        $filminfo['pagetext'] = preg_replace(            '/'.preg_quote($filminfo['title']).'|'.preg_quote($filminfo['title_o']).'/i',            '<a href="'.$filminfo['link'].'" title="$0"><strong>$0</strong></a>',            $filminfo['pagetext'],            1        );        $filminfo['pagetext'] = str_replace('Chúc các bạn xem phim', 'Chúc các bạn <a href="http://tronbohd.com" title="Xem Phim"><strong>xem phim</strong></a>', $filminfo['pagetext']);        // restore a, img        $filminfo['pagetext'] = str_ireplace(array_keys($replaces), array_values($replaces), $filminfo['pagetext']);        // keyword for search        $keywords = $filminfo['tags']. ", xem phim $filminfo[title], phim $filminfo[title] online, phim $filminfo[title_o]";        if($searched_by_keywords = @unserialize($filminfo['searched_by_keywords']))        {            $keywords .= ',' . implode(',', array_keys(array_slice($searched_by_keywords, 0, 3)));            $keywords = implode(', ', array_unique(explode(',', $keywords)));        }        $filminfo[tags_link] = Light_Helper_String::rand_array($filminfo[tags_link]);        //$filminfo['keywords'] = $filminfo['tags'] . implode(',', $filminfo['tags']);        if(empty($filminfo[pagetext2])){            $description = $filminfo['description'];        }else{            $description = $filminfo['description2'];        }        $view_params = array(            'page_title' => "Nội Dung Phim $filminfo[title] | Full HD | Nội Dung Phim $filminfo[title_o] $filminfo[year]",            'page_keywords' =>  $keywords,            'page_description' => 'Nội Dung Phim ' . $filminfo['title'] . ', '.$filminfo['title'].', '.$filminfo['title'].' Full '.$filminfo[year].': ' . $description,            'filminfo' => $filminfo,            'url_canonical' => $url_canonical,        );        // check google search        if($keyword = Light_Helper_Film::detect_keyword_from_search())        {            Light_Helper_Film::add_keyword_to_film($filminfo, $keyword);        }        $this->response_view('content', $view_params,'2');    }} 