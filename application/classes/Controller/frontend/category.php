<?php defined('SYSPATH') or die('No direct script access.');class Controller_Frontend_Category extends Controller_Frontend {	protected function _perpare_criteria_for_search(array $filters){		$criteria = array();		foreach(array('country_id', 'category_id', 'year', 'post_user_id') as $field) {			if( ! empty($filters[$field])){				$criteria[$field] = $filters[$field];			}		}		//$criteria['order'] = array('film.last_update' => 'DESC');		$criteria['order'] = array('film.post_date' => 'DESC');		if( in_array($filters['order_by'], array('views', 'title', 'last_update', 'year', 'liked_times'))) {			$criteria['order'] = array('film.' . $filters['order_by'] => 'DESC');		}		$criteria['active'] = 1;		return $criteria;	}	public function action_index(){		$title_ascii = Light_Helper_Base::remove_accent_vn(			$this->_input->filter_single('title_ascii', Light_Input::STRING)		);		$film_model = $this->_get_film_model();		$category_model = $this->_get_category_model();		if(empty($title_ascii) OR !$category = $category_model->get_category_by_title_ascii($title_ascii)) {			$this->redirect(				Light_Link::build('error', 'action=404', 'path=' . $this->request->uri())			);		}		$page = $this->_input->filter_single('page', Light_Input::UINT);		$page = max($page, 1);		$perpage = Light_Application::get('options')->films_per_page;		$filters = $this->_input->filter(array(			'order_by'		=> Light_Input::STRING,			'year' 			=> Light_Input::UINT,			'country_id'	=> Light_Input::UINT,			'category_id'	=> Light_Input::UINT,		));		// to SEO		$year = date('Y');		$block['title'] 		= "Phim $category[title]";		$category['link'] 		= Light_Link::build('category', $category);		$view_params = array(			'category'			=> $category,			'show'	=> array(				'country_filter' 	=> 1,				'category_filter' 	=> 0,				'year_filter' 		=> 1,				'order_filter' 		=> 1,			),		);		if( ! $filters['year']){            switch($block['title']){                case 'Phim Hoạt Hình':{                    $view_params += array(                        'page_title'		=> "Xem Phim $category[title] hay, hot nhất $year, phim $title_ascii moi $year",                        'page_keywords'		=> "Phim $category[title], Xem phim $title_ascii, Phim $category[title] $year, xem phim $category[title] $year, phim $category[title] hay, Phim $category[title] mới nhất",                        'page_description'	=> "Phim $title_ascii, Phim $category[title] mới nhất $year, Phim $category[title] nhật bản, Phim $category[title] mỹ, Phim $category[title] hay mới nhất. doremon, tom and jery, conan, naruto, pokemon......",                    );                    break;                }                case 'Phim Hài Hước':{                    $view_params += array(                        'page_title'		=> "Xem Phim $category[title] hay, hot nhất $year, phim $title_ascii moi $year",                        'page_keywords'		=> "Phim $category[title], Xem phim $title_ascii, Phim $category[title] $year, xem phim $category[title] $year, phim $category[title] hay, Phim $category[title] mới nhất",                        'page_description'	=> "Phim $title_ascii, phim $title_ascii $year, tổng hợp các thể loại phim $category[title] của các danh hài nổi tiếng, Những phim $category[title] và mới nhất $year",                    );                    break;                }                case 'Phim Tình Cảm':{                    $view_params += array(                        'page_title'		=> "Xem Phim $category[title] hay, hot nhất $year, phim $title_ascii moi $year",                        'page_keywords'		=> "Phim $category[title], Xem phim $title_ascii, Phim $category[title] $year, xem phim $category[title] $year, phim $category[title] hay, Phim $category[title] mới nhất",                        'page_description'	=> "Phim $title_ascii, phim $title_ascii $year, Phim $category[title] hàn quốc hay, Phim $category[title] mỹ, Phim $category[title] hay mới nhất, Thể loại phim $category[title] $year",                    );                    break;                }                case 'Phim Kinh Dị':{                    $view_params += array(                        'page_title'		=> "Xem Phim $category[title] hay, hot nhất $year, phim $title_ascii moi $year",                        'page_keywords'		=> "Phim $category[title], Xem phim $title_ascii, Phim $category[title] $year, xem phim $category[title] $year, phim $category[title] hay, Phim $category[title] mới nhất",                        'page_description'	=> "Tổng hợp phim $category[title] xem là sợ, phim $title_ascii, phim $category[title] mỹ, phim $category[title] mới nhất $year, các phim $category[title] dành cho những ai ko biết sợ..",                    );                    break;                }                case 'Phim TV Show':{                    $view_params += array(                        'page_title'		=> "Xem Phim $category[title] hay, hot nhất $year, phim $title_ascii moi $year",                        'page_keywords'		=> "Phim $category[title], Xem phim $title_ascii, Phim $category[title] $year, xem phim $category[title] $year, phim $category[title] hay, Phim $category[title] mới nhất",                        'page_description'	=> "Tổng hợp những phim chiếu trên Tivi, phim trên các kênh truyền hình HTV9, VTV3, HTV... rất nhiều phim hay và mới được cập nhật liên tục tại đây",                    );                    break;                }                case 'Phim Chiếu Rạp':{                    $view_params += array(                        'page_title'		=> "Xem phim $category[title] hay, mới nhất $year, Tong hop phim $title_ascii moi $year",                        'page_keywords'		=> "Phim $category[title], Xem phim $title_ascii, Phim $category[title] $year, xem phim $category[title] $year, Phim $category[title] hay, Phim $category[title] mới nhất",                        'page_description'	=> "Tổng hợp tất cả những bộ phim $category[title] hay nhất và mới nhất $year, Phim $title_ascii hot $year, những bộ phim $title_ascii của Việt Nam và điện ảnh thế giới...",                    );                    break;                }                case 'Phim Thuyết Minh':{                    $view_params += array(                        'page_title'		=> "Danh sách phim $category[title] hay, Phim $title_ascii, Phim Lồng Tiếng $year mới nhất",                        'page_keywords'		=> "Phim lồng tiếng, Phim 2014, Phim $category[title], Phim hot $year, Phim $year mới nhất",                        'page_description'	=> "Xem phim hay, phim mới có thuyết minh (lồng tiếng), danh sách các phim mới nhất $year...",                    );                    break;                }                case 'Phim Tâm Lý':{                    $view_params += array(                        'page_title'		=> "Xem Phim $category[title] hay, hot nhất $year, phim $title_ascii moi $year",                        'page_keywords'		=> "Phim $category[title], Xem phim $title_ascii, Phim $category[title] $year, xem phim $category[title] $year, phim $category[title] hay, Phim $category[title] mới nhất",                        'page_description'	=> "Phim $title_ascii, phim $title_ascii $year, tổng hợp các thể loại phim $category[title] của các danh hài nổi tiếng, Những phim $category[title] và mới nhất $year",                    );                    break;                }                default:{                    $view_params += array(                        'page_title'		=> "Xem Phim $category[title] hay, hot nhất $year, phim $title_ascii moi $year",                        'page_keywords'		=> "Phim $category[title], Xem phim $category[title], Phim $category[title] $year, xem phim $category[title] $year, phim $category[title] hay, Phim $category[title] mới nhất",                        'page_description'	=> "Phim $title_ascii, Phim $category[title] mới nhất $year, Phim $category[title] mỹ, Phim $category[title] trung quốc, Phim $category[title] chọn lọc. cực hay và hấp dẫn nhất...",                    );                    break;                }            }		} else {			$year = $filters['year'];			$block['title'] 	= "Phim $category[title] $year";			$view_params += array(                'page_title'		=> "Xem Phim $category[title] $year hay nhất, Phim $category[title] hot $year mới nhất",                'page_keywords'		=> "Phim $category[title], Xem phim $category[title], Phim $category[title] $year, xem phim $category[title] $year, phim $category[title] hay, Phim $category[title] mới nhất",                'page_description'	=> "Xem phim $category[title] hay nhất $year. Tổng hợp các bộ phim $category[title] hay nhất, mới nhất và hấp dẫn nhất của diện ảnh thế giới...",			);			}		// prepare criteria		$criteria = $this->_perpare_criteria_for_search($filters);		$criteria['category_id'] = $category['category_id'];		$count_films = $film_model->get_count_films($criteria);		$total_pages = ceil($count_films/$perpage);		$page = min($page, $total_pages);		$films = array();		if($count_films) {			$films = $film_model->get_films($criteria, array(				'page' => $page,				'perpage' => $perpage,				'order' => $criteria['order'],			));			$films = array_map('Light_Helper_Film::parse', $films);		}		list($left, $right) = explode('__page',			Light_Link::build('category', $category + array('page' => '__page'), $this->request->query())		);		$page_nav = Light_Helper_Base::page_navigation($page, $total_pages, $left, $right);		if($page > 1)		{			$category += array('page' => $page);		}		$view_params += array(			'filters' => $filters,			'films' => $films,			'block' => $block,			'page_nav' => $page_nav,		);		return $this->response_view('list', $view_params);	}	protected function _get_film_model(){		return $this->get_model('Light_Model_Film');	}	protected function _get_country_model(){		return $this->get_model('Light_Model_Country');	}	protected function _get_category_model(){		return $this->get_model('Light_Model_Category');	}}