;(function($,window,document,undefined){var pluginName='Kenburns',defaults={images:[],duration:400,fadeSpeed:500,scale:1,ease3d:'cubic-bezier(.81, 0, .26, 1)',onLoadingComplete:function(){},onSlideComplete:function(){},onListComplete:function(){},getSlideIndex:function(){return currentSlide;}};var imagesObj={};var currentSlide=0;function Plugin(element,options){this.element=element;this.options=$.extend({},defaults,options);this._defaults=defaults;this._name=pluginName;this.maxSlides=this.options.images.length;this.init();}
Plugin.prototype.init=function(){var list=this.options.images;var that=this;this.width=$(this.element).width();this.height=$(this.element).height();this.has3d=has3DTransforms();for(i in list){imagesObj["image"+i]={};imagesObj["image"+i].loaded=false;this.attachImage(list[i],"image"+i,i);}
var loader=$('<div/>');loader.addClass('loader');loader.css({'position':'absolute','z-index':10000});$(this.element).prepend(loader);};Plugin.prototype.attachImage=function(url,alt_text,index){var that=this;var wrapper=$('<div/>');wrapper.attr('class','kb-slide');wrapper.css({'opacity':0});var img=$("<img />");img.attr('src',url);img.attr('alt',alt_text);wrapper.html(img);if(this.has3d){img.css({'-webkit-transform-origin':'left top'});img.css({'-moz-transform-origin':'left top'});img.css({'-webkit-transform':'scale('+that.options.scale+') translate3d(0,0,0)'});img.css({'-moz-transform':'scale('+that.options.scale+') translate3d(0,0,0)'});}
this.doTransition=(this.has3d)?this.transition3d:this.transition;img.load(function(){imagesObj["image"+index].element=this;imagesObj["image"+index].loaded=true;imagesObj["image"+index].width=$(this).width();imagesObj["image"+index].width=$(this).height();that.insertAt(index,wrapper);that.resume(index);});}
Plugin.prototype.resume=function(index){if(index==0){this.startTransition(0);$(this.element).find('.loader').hide();}
if(index==this.holdup){$('#status').html("");$(this.element).find('.loader').hide();this.startTransition(this.holdup);}
if(this.checkLoadProgress()==true){$(this.element).find('.stalled').each(function(){$(this).css({'opacity':1,'z-index':1});$(this).removeClass('stalled');});this.options.onLoadingComplete();}}
Plugin.prototype.checkLoadProgress=function(){var imagesLoaded=true;for(i=0;i<this.maxSlides;i++){if(imagesObj["image"+i].loaded==false){imagesLoaded=false;}}
return imagesLoaded;}
Plugin.prototype.wait=function(){clearInterval(this.interval);$('#status').html("loading");$(this.element).find('.loader').show();var image=imagesObj["image"+(currentSlide-1)].element;$(image).parent().stop(true,true);$(image).parent().addClass('stalled');}
Plugin.prototype.startTransition=function(start_index){var that=this;currentSlide=start_index;that.doTransition();this.interval=setInterval(function(){if(currentSlide<that.maxSlides-1){currentSlide++;}else{currentSlide=0;}
if(imagesObj["image"+currentSlide].loaded==false){that.holdup=currentSlide;that.wait();}else{that.doTransition();}},this.options.duration);}
Plugin.prototype.chooseCorner=function(){var scale=this.options.scale;var image=imagesObj["image"+currentSlide].element;var ratio=image.height/image.width;var sw=Math.floor($(this.element).width()*(1/scale));var sh=Math.floor($(this.element).width()*ratio*(1/scale));$(image).width(sw);$(image).height(sh);var w=$(this.element).width();var h=$(this.element).height();var corners=[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}];var choice=Math.floor(Math.random()*4);var start=corners[choice];corners.splice(choice,1);var end=corners[Math.floor(Math.random()*3)];var coordinates={startX:start.x*(w- sw*scale),startY:start.y*(h- sh*scale),endX:end.x*(w- sw),endY:end.y*(h- sh)}
return coordinates;}
Plugin.prototype.transition3d=function(){var that=this;var scale=this.options.scale;var image=imagesObj["image"+currentSlide].element;var position=this.chooseCorner();$(image).css({'-webkit-transition':'none'});$(image).css({'-moz-transition':'none'});$(image).css({'-webkit-transform':'scale('+scale+') translate3d('+position.startX+'px,'+position.startY+'px,0)'});$(image).css({'-moz-transform':'scale('+scale+') translate3d('+position.startX+'px,'+position.startY+'px,0)'});$(image).parent().css({'opacity':0,'z-index':'3'});$(image).parent().animate({'opacity':1},that.options.fadeSpeed);$(image).css({'-webkit-transition':'-webkit-transform '+(that.options.duration+that.options.fadeSpeed)+'ms '+that.options.ease3d});$(image).css({'-moz-transition':'-moz-transform '+(that.options.duration+that.options.fadeSpeed)+'ms '+that.options.ease3d});$(image).css({'-webkit-transform':'scale(1) translate3d('+position.endX+'px,'+position.endY+'px,0)'});$(image).css({'-moz-transform':'scale(1) translate3d('+position.endX+'px,'+position.endY+'px,0)'});this.transitionOut();this.options.onSlideComplete();}
Plugin.prototype.transition=function(){var that=this;var scale=this.options.scale;var image=imagesObj["image"+currentSlide].element;var sw=$(image).width();var sh=$(image).height();var position=this.chooseCorner();$(image).css({'left':position.startX,'top':position.startY,'width':sw*(scale),'height':sh*(scale)});$(image).animate({'left':position.endX,'top':position.endY,'width':sw,'height':sh},that.options.duration+ that.options.fadeSpeed);$(image).parent().css({'opacity':0,'z-index':3});$(image).parent().animate({'opacity':1},that.options.fadeSpeed);this.transitionOut();this.options.onSlideComplete();}
Plugin.prototype.transitionOut=function(){var that=this;var image=imagesObj["image"+currentSlide].element;$(image).parent().delay(that.options.duration).animate({'opacity':0},that.options.fadeSpeed,function(){$(this).css({'z-index':1});});}
function has3DTransforms(){var el=document.createElement('p'),has3d,transforms={'WebkitTransform':'-webkit-transform','MozTransform':'-moz-transform',};document.body.insertBefore(el,null);for(var t in transforms){if(el.style[t]!==undefined){el.style[t]="translate3d(1px,1px,1px)";has3d=window.getComputedStyle(el).getPropertyValue(transforms[t]);}}
document.body.removeChild(el);return(has3d!==undefined&&has3d.length>0&&has3d!=="none");}
Plugin.prototype.insertAt=function(index,element){var lastIndex=$(this.element).children().size();if(index<0){index=Math.max(0,lastIndex+ 1+ index);}
var imgWrapper=$(this.element).append(element);if(index<lastIndex){$(this.element).children().eq(index).before($(this.element).children().last());}}
$.fn[pluginName]=function(options){return this.each(function(){if(!$.data(this,'plugin_'+ pluginName)){$.data(this,'plugin_'+ pluginName,new Plugin(this,options));}});}})(jQuery,window,document);